###TO NOTE Every other concentration represents a patient, delay, times
###TODO add in risk from coresponding dose
###TODO get line of best fit stats out

library(dplyr)
library(tidyr)
library(truncdist)
library(vroom)
library(janitor)
library(zoo)
library(shiny)
library(flexdashboard)
library(parallel)
library(ggplot2)
library(data.table)
library(DT)
library(personograph)
library(RColorBrewer)
library(plotly)
library(cowplot)



##### Finding Breathing rate, affecting emission rate
m<-1.52365; s<-1.151533
# Breathing rate
#p is in l/min
p1<-c(10.8,13.1,8.2,11.6,7.2,8.6,10.9,11.0,10.8,9.9,11.4,10.6,9.8,10.9,
      9.3,8.6,12.0,12.1,12.6,9.9)
p2=c(10.46, 11.48, 13.41, 16.13,16.55)
pval=c(p1,p2)
meanp=mean(pval)
stdp=sd(pval)
pmin=meanp-stdp
pmax=meanp+stdp
pdiff=pmax-pmin
SEM = stdp/sqrt(NROW(pval))             # Standard Error
ts =  qt(c(.025, .975), df=NROW(pval)-1)   # T-Score
CI = meanp + ts*SEM                     # Confidence Intervals

####### Inputs manually chosen

N=1000
set.seed(42)
times_appt=runif(N,min = 10,max = 120)
ach=runif(N,min = 0.1,max = 6)
delay=runif(N,min = 1,max = 30)
k=runif(N,min = 50,max = 1000)#rep(1e-4,N)
V =runif(N,min=10, max=40) 
E=(runif(N,min=550, max=1510))/3600
# logE=runif(N,min=0.1, max=5)
p=(runif(N,min = 6, max=17))*0.001/60
#logE = truncdist::rtrunc(n = N , spec = "norm" ,a = 0 ,b = 6, mean=m, sd=s)
# E = (10^(logE))/3600
#p = ((CI[1]+runif(N)*CI[2]+runif(N))*0.001)/60 
half_life = 30+runif(N, min=0,max=121) #### half_life affects lambda which is removal rate
#half life of PsA 30 to 151 mins from "Viability of Pseudomonas aeruginosa in cough aerosols generated by persons with cystic fibrosis

#Find lambda which is the addtion of the removal rates
lambda_v <- ach/3600 #1 ac/h, so divide by 3600 to get ac/s
half_life_s  <- half_life*60; #get in seconds
lambda_i <- log(2)/half_life_s   #removal due to inactivation
lambda_d  <- 0     #removal due to deposition
lambda  <- lambda_v+lambda_i+lambda_d

### Numerical ODE

numerical_ODE<-function(t, state, parameters) {
  with(as.list(c(state, parameters)),{
    dC<-E/V-lambda*C
    list(dC)
  })
}


# Analytical Solution --------------------------------------------------------



analyticalODE <- function(times,E,V,lambda,C01){
  t=seq(0,NROW(times)-2) #need to convert from times seconds to 0-maxtime, to allow comparison with the ODE solver # problem if lambda is a function of time
  data.frame(times=t,
             C=E/(V*lambda)*(1-exp(-lambda*t))+C01*exp(-lambda*t))
}

# AUC function (Area Under Curve) -------------------------------------------------------


AUC <- function(x,y){ #To allow for non-uniform time-steps
  sum(diff(x[order(x)])*zoo::rollmean(y[order(x)],2))
}



# Exposure function -----------------------------------------------------
exposure<-function(E,p,ach,times,times_appt,delay,k,V,lambda){
  
  H <- 2 ##### Number of iterations per minute selected here
  Z <- 60/H
  
  #Variable volume
  #area from all room sizes
  
  ####### Part 1 patient in the room
  
  t01=0
  tend1= as.numeric(times_appt)*60 #X * 60 X is time in mins, to give seconds
  C01=0   #assume no intial concentration of CFU in the air
  
  times <- seq(t01, tend1, by = Z)
  parameters<-c(E,V,lambda)
  init<-c(C=C01)
  
  analyticalODE(times,E,V,lambda,C01)-> out1
  
  ###### Part 2 patient leaves the room
  
  #Intial conditions
  t02=tend1
  tend2= tend1 +(as.numeric(delay)*60); #X * 60 X is time in mins
  
  times <- seq(t02, tend2, by = Z)
  #C02=C1(end)    #takes the last concentration value form simulation 1
  #E0=0           #emission now 0
  
  parameters<-c(0,V,lambda)
  init<-c(C=out1$C[NROW(out1)])
  
  analyticalODE(times,0,V,lambda,out1$C[NROW(out1)])-> out2
  
  ####### Part 3 1st susceptible patient enters room and breaths in CFU
  
  #Intial conditions
  #E0=0
  t03=tend2
  tend3= tend2 +as.numeric(times_appt)*60 #X * 60 X is time in mins
  #tspan2=[t02 tend2]
  times <- seq(t03, tend3, by = Z)
  #C02=C1(end)    #takes the last concentration value form simulation 1
  #E0=0           #emission now 0
  
  parameters<-c(0,V,lambda)
  init<-c(C=out2$C[NROW(out2)])
  
  analyticalODE(times,0,V,lambda,out2$C[NROW(out2)])-> out3
  
  ####### Part 4 1st susceptible patient leaves room
  
  #Intial conditions
  #E0=0
  t04=tend3
  tend4= tend3 +as.numeric(delay)*60 #X * 60 X is time in mins
  #tspan2=[t02 tend2]
  times <- seq(t04, tend4, by = Z)
  #C02=C1(end)    #takes the last concentration value form simulation 1
  #E0=0           #emission now 0
  
  parameters<-c(0,V,lambda)
  init<-c(C=out3$C[NROW(out3)])
  
  analyticalODE(times,0,V,lambda,out3$C[NROW(out3)])-> out4
  
  ####### Part 5 2nd susceptible patient enters room
  
  #Intial conditions
  #E0=0
  t05=tend4
  tend5= tend4 +as.numeric(times_appt)*60 #X * 60 X is time in mins
  #tspan2=[t02 tend2]
  times <- seq(t05, tend5, by = Z)
  #C02=C1(end)    #takes the last concentration value form simulation 1
  #E0=0           #emission now 0
  
  parameters<-c(0,V,lambda)
  init<-c(C=out4$C[NROW(out4)])
  
  analyticalODE(times,0,V,lambda,out4$C[NROW(out4)])-> out5
  
  ####### Part 6 2nd susceptible patient leaves room
  
  #Intial conditions
  #E0=0
  t06=tend5
  tend6= tend5 +as.numeric(delay)*60 #X * 60 X is time in mins
  #tspan2=[t02 tend2]
  times <- seq(t06, tend6, by = Z)
  #C02=C1(end)    #takes the last concentration value form simulation 1
  #E0=0           #emission now 0
  
  parameters<-c(0,V,lambda)
  init<-c(C=out5$C[NROW(out5)])
  
  analyticalODE(times,0,V,lambda,out5$C[NROW(out5)])-> out6
  
  ####### Part 7 3rd susceptible patient enters room
  
  #Intial conditions
  #E0=0
  t07=tend6
  tend7= tend6 +as.numeric(times_appt)*60 #X * 60 X is time in mins
  #tspan2=[t02 tend2]
  times <- seq(t07, tend7, by = Z)
  #C02=C1(end)    #takes the last concentration value form simulation 1
  #E0=0           #emission now 0
  
  parameters<-c(0,V,lambda)
  init<-c(C=out6$C[NROW(out6)])
  
  analyticalODE(times,0,V,lambda,out6$C[NROW(out6)])-> out7
  
  ####### Part 8 3rd susceptible patient leaves room
  
  #Intial conditions
  #E0=0
  t08=tend7
  tend8= tend7 +as.numeric(delay)*60 #X * 60 X is time in mins
  #tspan2=[t02 tend2]
  times <- seq(t08, tend8, by = Z)
  #C02=C1(end)    #takes the last concentration value form simulation 1
  #E0=0           #emission now 0
  
  parameters<-c(0,V,lambda)
  init<-c(C=out7$C[NROW(out7)])
  
  analyticalODE(times,0,V,lambda,out7$C[NROW(out7)])-> out8
  
  ####### Part 9 4th susceptible patient enters room
  
  #Intial conditions
  #E0=0
  t09=tend8
  tend9= tend8 +as.numeric(times_appt)*60 #X * 60 X is time in mins
  #tspan2=[t02 tend2]
  times <- seq(t09, tend9, by = Z)
  #C02=C1(end)    #takes the last concentration value form simulation 1
  #E0=0           #emission now 0
  
  parameters<-c(0,V,lambda)
  init<-c(C=out8$C[NROW(out8)])
  
  analyticalODE(times,0,V,lambda,out8$C[NROW(out8)])-> out9
  
  tmp1<-
    out3%>%
    summarise(dose=AUC(times,C*p))%>%
    mutate(risk=1-exp(-dose/as.numeric(k)))
  
  tmp2<-
    out5%>%
    summarise(dose=AUC(times,C*p))%>%
    mutate(risk=1-exp(-dose/as.numeric(k)))
  
  tmp3<-
    out7%>%
    summarise(dose=AUC(times,C*p))%>%
    mutate(risk=1-exp(-dose/as.numeric(k)))
  
  tmp4<-
    out9%>%
    summarise(dose=AUC(times,C*p))%>%
    mutate(risk=1-exp(-dose/as.numeric(k))) #Note the multiplication instead of division, this is because of how the dose-response parameter is given
  

  exposure<-data.frame(#C1=out1$C[NROW(out1)],
    #C2=out2$C[NROW(out2)],
    C3=out3$C[NROW(out3)],
    #C4=out4$C[NROW(out4)],
    C5=out5$C[NROW(out5)],
    #C6=out6$C[NROW(out6)],
    C7=out7$C[NROW(out7)],
    #C8=out8$C[NROW(out8)],
    C9=out9$C[NROW(out9)],
    # dose3=tmp3$dose3,
    # risk3=tmp3$risk3,
    # dose5=tmp5$dose5,
    # risk5=tmp5$risk5,
    # dose7=tmp7$dose7,
    # risk7=tmp7$risk7,
    # dose9=tmp9$dose9,
    # risk9=tmp9$risk9,
    dose3=tmp1$dose,
    risk3=tmp1$risk,
    dose5=tmp2$dose,
    risk5=tmp2$risk,
    dose7=tmp3$dose,
    risk7=tmp3$risk,
    dose9=tmp4$dose,
    risk9=tmp4$risk,
    # dose=tmp3$dose3+tmp5$dose5+tmp7$dose7+tmp9$dose9,
    # risk=tmp3$risk3+tmp5$risk5+tmp7$risk7+tmp9$risk9
    dose=tmp1$dose+tmp2$dose+tmp3$dose+tmp4$dose,
    risk=tmp1$risk+tmp2$risk+tmp3$risk+tmp4$risk
  )
  
  return(exposure)
  
}

df=mcmapply(FUN = exposure,E,p,ach,times,times_appt,delay,k,V,lambda,mc.cores = 1) %>%
  t()%>%
  as.data.frame() %>%
  # unnest(cols=c( C3, C5, C7,C9,dose3, risk3,dose5, risk5,dose7, risk7,dose9, risk9,dose, risk))
  unnest(cols=c(dose3,risk3,dose5,risk5,dose7,risk7,dose9,risk9,dose,risk))
# unnest(cols=c(C1, C2, C3, C4, C5, C6, C7,C8,C9,dose, risk))
# unnest(cols=c(C1, C2, C3, C4, C5, C6, C7,C8,C9))
#pivot_longer(!c(dose,risk))


df=cbind(df,E,p,ach,times, times_appt,delay,k,V,lambda)




broom::tidy(fit.lm)

# df$risk <- as.factor(df$risk)
# head(df)

# p <- ggplot(df, aes(x=c(C3,C5,C7,C9), y=risk)) + 
#   geom_violin()
# p
p9 <- ggplot(df, aes(x=C3, y=risk3)) + 
   ylim(c(0,0.00225))+
  # xlim(c(0,20))+
  #xlim(c())+
  xlab("Patient 1")+
  ylab("Risk of Infection")+
  geom_violin()+
  hrbrthemes::theme_ipsum()

p10 <- ggplot(df, aes(x=C5, y=risk5)) + 
   ylim(c(0,0.00225))+
  # xlim(c(0,20))+
  xlab("Patient 2")+
  ylab("Risk of Infection")+
  geom_violin()+
  hrbrthemes::theme_ipsum()

p11 <- ggplot(df, aes(x=C7, y=risk7)) + 
   ylim(c(0,0.00225))+
  # xlim(c(0,20))+
  xlab("Patient 3")+
  ylab("Risk of Infection")+
  geom_violin()+
  hrbrthemes::theme_ipsum()

p12 <- ggplot(df, aes(x=C9, y=risk9)) + 
   ylim(c(0,0.00225))+
  # xlim(c(0,20))+
  xlab("Patient 4")+
  ylab("Risk of Infection")+
  geom_violin()+
  hrbrthemes::theme_ipsum()

plot_row2 <- plot_grid(p9, p10, p11, p12, ncol = 2)

title <- ggdraw() + 
  draw_label(
    "Risk by patient",
    fontface = 'bold',
    x = 0,
    hjust = 0
  ) +
  theme(
    # add margin on the left of the drawing canvas,
    # so title is aligned with left edge of first plot
    plot.margin = margin(0, 0, 0, 7)
  )
plot_grid(
  title, plot_row2,
  ncol = 1,
  # rel_heights values control vertical title margins
  rel_heights = c(0.05, 0.5)
)



